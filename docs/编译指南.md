# RetroArch iOS 编译指南

## 概述

本指南说明如何编译gam4980核心并集成到RetroArch iOS中。

## 第一步：编译gam4980核心

### 自动编译（推荐）

```bash
cd gam4980/src
bash ../../docs/build_ios.sh
```

### 手动编译

```bash
# 1. 进入源码目录
cd gam4980/src

# 2. 编译核心
# 重要：只编译libretro.c，s6502.c通过#include包含其中
xcrun -sdk iphoneos clang -arch arm64 \
    -miphoneos-version-min=11.0 \
    -O3 -fPIC -dynamiclib \
    -o gam4980_libretro.dylib \
    libretro.c

# 3. 签名
codesign -s - gam4980_libretro.dylib

# 4. 验证输出
file gam4980_libretro.dylib
# 应显示: Mach-O 64-bit dynamically linked shared library arm64

# 5. 创建info文件
cat > gam4980_libretro.info << 'EOF'
display_name = "BBK Electronic Dictionary (GAM4980)"
authors = "iyzsong|无云"
supported_extensions = "bin|rom|dat"
corename = "GAM4980"
categories = "Emulator"
systemname = "BBK Electronic Dictionary"
license = "GPLv3"
EOF
```

## 第二步：编译RetroArch

### 1. 获取源码

```bash
git clone https://github.com/libretro/RetroArch.git
cd RetroArch
```

### 2. 添加核心文件

```bash
# 创建目录
mkdir -p pkg/apple/iOS/modules

# 复制核心文件
cp path/to/gam4980_libretro.dylib pkg/apple/iOS/modules/
cp path/to/gam4980_libretro.info pkg/apple/iOS/modules/
```

### 3. Xcode配置

打开项目：
```bash
open pkg/apple/RetroArch_iOS.xcodeproj
```

配置步骤：

1. **选择Target**
   - 选择 "RetroArch iOS" target

2. **签名设置**
   - Signing & Capabilities → Team → 选择您的团队
   - Bundle Identifier → 修改为唯一值（如：com.yourname.retroarch）
   - 勾选 "Automatically manage signing"

3. **添加核心到项目**
   - 右键 Resources 文件夹
   - Add Files to "RetroArch iOS"
   - 选择 `gam4980_libretro.dylib` 和 `gam4980_libretro.info`
   - 确保勾选：
     - ✅ Copy items if needed
     - ✅ Add to targets: RetroArch iOS

4. **Build Settings**
   - Architectures: Standard Architectures (arm64)
   - iOS Deployment Target: 11.0
   - Build Active Architecture Only: 
     - Debug: Yes
     - Release: No

### 4. 编译运行

#### 直接运行（最快）
```
Product → Run (⌘R)
```

#### 生成IPA

**方法1：Xcode Archive**
1. Product → Archive
2. Window → Organizer
3. Distribute App → Development
4. Export → 保存IPA

**方法2：命令行**
```bash
# Archive
xcodebuild -project pkg/apple/RetroArch_iOS.xcodeproj \
           -scheme "RetroArch iOS" \
           -configuration Release \
           -archivePath build/RetroArch.xcarchive \
           archive

# 导出IPA
xcodebuild -exportArchive \
           -archivePath build/RetroArch.xcarchive \
           -exportPath build/ \
           -exportOptionsPlist ExportOptions.plist
```

## 第三步：配置ROM文件

### 文件位置
```
Documents/
└── system/
    └── gam4980/
        ├── 8.BIN    # 字体ROM
        └── E.BIN    # 系统ROM
```

### 传输方法

1. **iTunes/Finder文件共享**
   - 连接设备到电脑
   - 打开iTunes或Finder
   - 选择设备 → 文件共享 → RetroArch
   - 拖入ROM文件

2. **通过Xcode**
   - Window → Devices and Simulators
   - 选择设备 → Installed Apps → RetroArch
   - 点击齿轮图标 → Download Container
   - 添加文件后Upload Container

## 故障排除

### 问题1：编译错误 "undeclared function"

**原因**：尝试单独编译s6502.c

**解决**：只编译libretro.c
```bash
# ✅ 正确
xcrun ... -o gam4980_libretro.dylib libretro.c

# ❌ 错误
xcrun ... -o gam4980_libretro.dylib libretro.c s6502.c
```

### 问题2：签名失败

```bash
# 使用ad-hoc签名
codesign --force --deep --sign - gam4980_libretro.dylib

# 查看可用证书
security find-identity -v -p codesigning
```

### 问题3：核心无法加载

```bash
# 检查架构
lipo -info gam4980_libretro.dylib
# 必须包含: arm64

# 检查依赖
otool -L gam4980_libretro.dylib
```

### 问题4：Xcode找不到核心

确保核心文件在正确位置：
- Build Phases → Copy Bundle Resources
- 确认包含 gam4980_libretro.dylib

## 优化建议

### 编译优化
```bash
# 最大性能优化
CFLAGS="-O3 -flto -ffast-math -march=native"

# 减小体积
CFLAGS="-Os -flto"
```

### 调试版本
```bash
# 添加调试符号
CFLAGS="-g -O0"
```

## 验证安装

1. 启动RetroArch
2. Settings → Directory → System/BIOS → 设置为Documents
3. Load Core → 查找 "BBK Electronic Dictionary"
4. Load Content → 选择ROM
5. 开始使用！

## 总结

完整流程：
1. 编译核心（5分钟）
2. 配置RetroArch（10分钟）
3. Xcode编译（30-60分钟）
4. 安装测试（10分钟）

总时间：约1-2小时